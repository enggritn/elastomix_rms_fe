@{
    ViewBag.Title = "Return";
    ViewBag.Module = "Return";
}

<div class="page-header">
    <div class="row align-items-end">
        <div class="col-lg-8">
            <div class="page-header-title">
                <i class="ik ik-inbox bg-blue"></i>
                <div class="d-inline">
                    <h5>@ViewBag.Title</h5>
                    <span>Edit</span>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <nav class="breadcrumb-container" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href=""><i class="ik ik-database"></i></a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="#">Outbound</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Edit @ViewBag.Title</li>
                </ol>
            </nav>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="form-group row">
                            <label class="col-form-label col-sm-4">Issue Slip Code</label>
                            <div class="col-sm-8">
                                <input type="text" autocomplete="off" id="Code" class="form-control" readonly />
                                <input type="hidden" id="ID" class="form-control" />
                                <input type="hidden" id="CodeHidden" class="form-control" />
                                <span class="help-block text-danger"></span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-form-label col-sm-4">Issue Slip Name</label>
                            <div class="col-sm-8">
                                <input type="text" autocomplete="off" class="form-control" id="Name" readonly />
                                <span class="help-block text-danger"></span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-form-label col-sm-4">WT Requested</label>
                            <div class="col-sm-8">
                                <input type="text" autocomplete="off" class="form-control" id="TotalRequestedQty" readonly />
                                <span class="help-block text-danger"></span>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-form-label col-sm-4">Status</label>
                            <div class="col-sm-8">
                                <input type="text" autocomplete="off" class="form-control" id="TransactionStatus" readonly />
                                <span class="help-block text-danger"></span>
                            </div>
                        </div>
                        <br />
                        <br />
                        <div class="form-group row">
                            <div class="col-md-12">
                                <label class="col-form-label"><b>Return List</b></label>
                            </div>
                        </div>
                        <div class="dt-responsive col-md-12">
                            <table class="table table-bordered table-striped nowrap" width="100%" cellspacing="0" id="listTable">
                                <thead>
                                    <tr>
                                        <th>RM Code</th>
                                        <th>RM Name</th>
                                        <th>Request Qty</th>
                                        <th>Vendor Name</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <br />
                        <br />
                        <div class="form-group row">
                            <div class="col-md-12">
                                <label class="col-form-label"><b>Return Detail</b></label>
                            </div>
                        </div>
                        <div class="dt-responsive col-md-12">
                            <table class="table table-bordered table-striped nowrap" width="100%" cellspacing="0" id="detailTable">
                                <thead>
                                    <tr>
                                        <th>Barcode</th>
                                        <th>QR Label</th>
                                        <th>Package</th>
                                        <th>Exp Date</th>
                                        <th>Approve Stamp</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="@Url.Action("Index", "Return")" class="btn btn-outline-info float-left"><i class="ik ik-arrow-left"></i>Back</a>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="formInspectionModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalTitle">Inspection Data</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group row">
                    <div class="offset-4 col-sm-8">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" name="QRLabel" id="QRLabel">
                            <label class="custom-control-label" for="QRLabel">QR Label</label>
                        </div>
                    </div>
                </div>
                <div class="form-group row">
                    <div class="offset-4 col-sm-8">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" name="Package" id="Package">
                            <label class="custom-control-label" for="Package">Package</label>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="inspectionID" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="ik ik-x-circle"></i>No</button>
                <button type="button" class="btn btn-primary" id="btnSaveInspection"><i class="ik ik-check-circle"></i>Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="formPutawayModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalTitle">Select BinRack</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="BinRackID" />
                <input type="hidden" id="putawayID" />
                <div class="dt-responsive col-md-12">
                    <table class="table table-bordered table-striped nowrap" id="BinRackDataTable" width="100%" cellspacing="0">
                        <thead class="thead-dark">
                            <tr>
                                <th></th>
                                <th>ID</th>
                                <th>BARCODE</th>
                                <th>BIN/RACK NAME</th>
                                <th>WAREHOUSE</th>
                                <th>AREA</th>
                                <th>STATUS</th>
                                <th>CREATED BY</th>
                                <th>CREATED ON</th>
                                <th>MODIFIED BY</th>
                                <th>MODIFIED ON</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="form-group row">
                    <label class="col-form-label col-sm-4">Bin/Rack code</label>
                    <div class="col-sm-8">
                        <input type="text" autocomplete="off" class="form-control" id="BinRackCode" readonly/>
                        <span class="help-block text-danger"></span>
                    </div>
                </div>
                <input type="hidden" id="BinRackCodeHidden" />
                <div class="form-group row">
                    <label class="col-form-label col-sm-4">Bin/Rack Name</label>
                    <div class="col-sm-8">
                        <input type="text" autocomplete="off" class="form-control" id="BinRackName" readonly/>
                        <span class="help-block text-danger"></span>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-form-label col-sm-4">Actual Return Qty</label>
                    <div class="col-sm-8">
                        <input type="text" autocomplete="off" class="form-control" id="ActualReturnQty" />
                        <span class="help-block text-danger"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="ik ik-x-circle"></i>No</button>
                <button type="button" class="btn btn-primary" id="btnSavePutaway"><i class="ik ik-check-circle"></i>Save</button>
            </div>
        </div>
    </div>
</div>

@section custom_css
{
    @Styles.Render("~/Content/plugins/datatables/dataTables.bootstrap4.min.css")
    @Styles.Render("~/Content/plugins/datatables/fixedColumns.bootstrap4.min.css")
    @Styles.Render("~/Content/plugins/toastr/toastr.css")
    <style>
        tr.row_selected td {
            background-color: lightblue !important;
        }
    </style>

}

@section custom_js
{
    <script type="text/javascript">
        let server = '@ViewBag.server';
        let module = '@ViewBag.Module';
        let token = '@Session["token"].ToString()';
        var isValid = true;
        initData();

        function initData() {
            $.ajax({
                type: 'GET',
                dataType: 'json',
                beforeSend: function (request) {
                    request.setRequestHeader('Token', token);
                },
                url: server + 'Api/IssueSlip/GetDataById?id=@ViewBag.Param',
                success: function (response) {
                    isValid = response.status;
                    if (isValid) {
                        var data = response.data;
                        $('#Name').val(data.Name);
                        $('#Code').val(data.Code);
                        $('#TotalRequestedQty').val(data.TotalRequestedQty);
                        $('#TransactionStatus').val(data.TransactionStatus);
                        initList();

                        //$('#listTable tbody').empty();
                        //var html = '';
                        //$.each(data.Details, function (index, value) {
                        //    html += '<tr>';
                        //    html += '<td>' + value.RawMaterialCode + '<input type="hidden" class="rawMateCode" value="' + value.RawMaterialCode + '"></td>';
                        //    html += '<input type="hidden" class="rawMateID" value="' + value.ID + '">';
                        //    html += '<td>' + value.RawMaterialName + '</td>';
                        //    html += '<td>' + value.RequestedQty + '</td>';
                        //    html += '<td>' + value.VendorName + '</td>';
                        //    html += '<td>';
                        //    html += '<a href="#" class="btn btn-primary" onclick="return ShowInspectionForm(\'' + value.RawMaterialCode + '\')"><i class="ik ik-search"></i>Inspection</a>&nbsp;';
                        //    html += '<a href="#" class="btn btn-primary" onclick="return ShowPutawayForm(\'' + value.RawMaterialCode + '\')"><i class="ik ik-inbox"></i>Putaway</a>&nbsp;';
                        //    html += '</td>';
                        //    html += '</tr>';
                        //});
                        //$('#listTable tbody').append(html);
                        //listTable.columns.adjust();
                    }
                }
            });
        }

        var listTable = null;

        function initList() {
            listTable = $('#listTable').DataTable({
            processing: true,
            serverSide: true,
            scrollY: "500px",
            scrollX: true,
            scrollCollapse: true,
            paging: true,
            order: [[1, "desc"]],
            ajax: {
                "dataType": "json",
                "type": "POST",
                "url": server + "Api/IssueSlip/DatatableDetail?HeaderID=@ViewBag.Param"
            },
            columns: [
                { "data": "RawMaterialCode", "name": "RawMaterialCode", "autoWidth": true },
                { "data": "RawMaterialName", "name": "RawMaterialName", "autoWidth": true },
                { "data": "RequestedQty", "name": "RequestedQty", "autoWidth": true },
                { "data": "VendorName", "name": "VendorName", "autoWidth": true },
                {
                    "data": null,
                    "render": function (data, type, row) {
                        let button = '';
                        if ($('#TransactionStatus').val() == 'OPEN') {
                            button += '<button class="btn btn-primary" onclick="return ShowInspectionForm(\'' + data.RawMaterialCode + '\')"><i class="ik ik-search"></i>Inspection</button> ';
                            button += '<button class="btn btn-primary" onclick="return ShowPutawayForm(\'' + data.RawMaterialCode + '\')"><i class="ik ik-inbox"></i>Putaway</button>';
                        }
                        return button;
                    }
                },
            ]
        });
        }

        function dissmissDialog() {
            $('#saveModal').modal('hide');
        }

        function ShowInspectionForm(id) {
            $('#inspectionID').val(id);
            $('#QRLabel').prop('checked', false);
            $('#Package').prop('checked', false);
            $('#formInspectionModal').modal('show');
        };

        function ShowPutawayForm(id) {
            $('#putawayID').val(id);
            $("#BinRackDataTable tbody tr").removeClass('row_selected');
            $('#formPutawayModal').modal('show');
        };


        $('#btnSaveInspection').on('click', function () {
            $.ajax({
                type: 'POST',
                dataType: "json",
                beforeSend: function (request) {
                    request.setRequestHeader('Token', token);
                },
                url: server + 'Api/IssueSlip/ReturnInspectionManual',
                data: {
                    HeaderID: '@ViewBag.param',
                    RawMaterialCode: $('#inspectionID').val(),
                    QRLabel: $('#QRLabel').prop('checked'),
                    Package: $('#Package').prop('checked'),
                },
                success: function (response) {
                    isValid = response.status;
                    if (isValid) {
                        listDatatable.ajax.reload();
                        detailDatatable.ajax.reload();
                        $('#formInspectionModal').modal('hide');
                        toastr.success(response.message);
                    } else {
                        dissmissDialog();
                        toastr.error(response.message);
                    }
                }
            });
        });

        $('#btnSavePutaway').on('click', function () {
            $.ajax({
                type: 'POST',
                dataType: "json",
                beforeSend: function (request) {
                    request.setRequestHeader('Token', token);
                },
                url: server + 'Api/IssueSlip/ReturnPutawayManual',
                data: {
                    HeaderID: '@ViewBag.param',
                    RawMaterialCode: $('#putawayID').val(),
                    BinRackCode: $('#BinRackCode').val(),
                    ActualReturnQty: $('#ActualReturnQty').val(),
                },
                success: function (response) {
                    isValid = response.status;
                    if (isValid) {
                        dissmissDialog();
                        $('#formPutawayModal').modal('hide');
                        toastr.success(response.message);
                    } else {
                        dissmissDialog();
                        toastr.error(response.message);
                    }
                }
            });
        });

        var BinRackDataTable = $('#BinRackDataTable').DataTable({
            processing: true,
            serverSide: true,
            scrollY: "500px",
            scrollX: true,
            scrollCollapse: true,
            paging: true,
            order: [[1, "desc"]],
            ajax: {
                "dataType": "json",
                "type": "POST",
                "url": server + "Api/BinRack/DatatableByWarehouse?warehouseId=WHxd92dec7c36974cbb9c9d398a69d62052"
            },
            columns: [
                {
                    "data": null,
                    "render" : function(data, type, row) {
                        return '<i class="ik ik-check"></i>';
                    }
                },
                { "data": "ID", "name": "ID", "autoWidth": true, visible: false },
                { "data": "Code", "name": "Code", "autoWidth": true },
                { "data": "Name", "name": "Name", "autoWidth": true },
                { "data": "WarehouseName", "name": "WarehouseName", "autoWidth": true },
                { "data": "BinRackAreaName", "name": "BinRackAreaName", "autoWidth": true },
                { "data": "IsActive", "name": "IsActive", "autoWidth": true },
                { "data": "CreatedBy", "name": "CreatedBy", "autoWidth": true },
                { "data": "CreatedOn", "name": "CreatedOn", "autoWidth": true },
                { "data": "ModifiedBy", "name": "ModifiedBy", "autoWidth": true },
                { "data": "ModifiedOn", "name": "ModifiedOn", "autoWidth": true },
            ]
        });

        $('#BinRackDataTable tbody').on('click', 'tr', function () {
            var data = BinRackDataTable.row(this).data();
            $('#BinRackID').val(data.ID);
            $('#BinRackName').val(data.Name);
            $('#BinRackCode').val(data.Code);
            $('#BinRackCodeHidden').val(data.Code);

            $("#BinRackDataTable tbody tr").removeClass('row_selected');
		    $(this).addClass('row_selected');
        });

        var detailTable = $('#detailTable').DataTable({
            processing: true,
            serverSide: true,
            scrollY: "500px",
            scrollX: true,
            scrollCollapse: true,
            paging: true,
            ajax: {
                "dataType": "json",
                "type": "POST",
                "url": server + "Api/IssueSlip/DatatableReturn?HeaderID=@ViewBag.param"
            },
            columns: [
                { "data": "Barcode", "name": "Barcode", "autoWidth": true },
                { "data": "UsageQRLabel", "name": "UsageQRLabel", "autoWidth": true },
                { "data": "UsagePackage", "name": "UsagePackage", "autoWidth": true },
                { "data": "UsageExpDate", "name": "UsageExpDate", "autoWidth": true },
                { "data": "UsageApproveStamp", "name": "UsageApproveStamp", "autoWidth": true },
                {
                    "data": null,
                    "render": function (data, type, row) {
                        //let button = '<a class="btn btn-outline-info" href="' + baseUrl + '/' + module + '/Detail?id=' + row.ID + '">';
                        //button += '<i class="ik ik-eye"></i>View</a>';
                        let button = '<button class="btn btn-primary" onclick="return ShowPutawayForm(\'' + data.Barcode + '\')"><i class="ik ik-inbox"></i>Putaway</button>&nbsp;';
                        return button;
                    }
                },
            ]
        });

    </script>
}
